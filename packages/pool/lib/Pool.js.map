{"version":3,"sources":["../src/Pool.js"],"names":["Pool","reportError","refErrorReporter","current","build","props","refProps","redux","rootReducer","buildRootReducer","refDucks","defaultRootReducer","composeEnhancers","window","__REDUX_DEVTOOLS_EXTENSION_COMPOSE__","x","enhancer","applyMiddleware","reduxSaga","sagaMiddleware","middlewares","store","buildStore","rootSaga","buildRootSaga","defaultRootSaga","run","initProps","ducks","initDucks","console","error","state","action","reduce","duck","poolName","duckName","sagas","errorReporter","push","pool","Object","defineProperty","value","writable","enumerable","get","reporter"],"mappings":"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","sourcesContent":["import { createStore, applyMiddleware } from 'redux'\nimport createSagaMiddleware from 'redux-saga'\nimport { spawn, call, all } from 'redux-saga/effects'\n\nexport default function Pool({\n  props: initProps = {},\n  ducks: initDucks = [],\n  buildStore = _props => {\n    return {}\n  },\n  buildRootReducer,\n  buildRootSaga,\n  middlewares = []\n} = {}) {\n  const refProps = { current: initProps || {} }\n  const refDucks = { current: initDucks || [] }\n  const refErrorReporter = { current: ('undefined' !== typeof console && console.error) || (() => {}) }\n\n  function addDuck(duck) {\n    refDucks.current.push(duck)\n  }\n\n  function setErrorReporter(reporter) {\n    refErrorReporter.current = reporter\n  }\n\n  function reportError(...args) {\n    if ('function' === typeof refErrorReporter.current) {\n      refErrorReporter.current(...args)\n    }\n  }\n\n  const redux = {\n    store: null,\n    defaultRootReducer(state, action) {\n      return refDucks.current.reduce((state, duck) => {\n        try {\n          return duck(state, action)\n        } catch (error) {\n          reportError(error, '@duckness/pool', 'reducer', duck.poolName, duck.duckName)\n          return state\n        }\n      }, state)\n    }\n  }\n\n  const reduxSaga = {\n    sagaMiddleware: createSagaMiddleware(),\n    *defaultRootSaga() {\n      const sagas = refDucks.current.reduce((sagas, duck) => {\n        if (duck.rootSaga) {\n          duck.errorReporter(refErrorReporter.current)\n          sagas.push(\n            spawn(function* () {\n              while (true) {\n                try {\n                  yield call(duck.rootSaga)\n                  break\n                } catch (error) {\n                  reportError(error, '@duckness/pool', 'saga', duck.poolName, duck.duckName)\n                }\n              }\n            })\n          )\n        }\n        return sagas\n      }, [])\n      yield all(sagas)\n    }\n  }\n\n  function build(props = refProps.current) {\n    refProps.current = props || {}\n    redux.rootReducer = buildRootReducer ? buildRootReducer(refDucks.current) : redux.defaultRootReducer\n    const composeEnhancers =\n      typeof window === 'object' && window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__\n        ? window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({})\n        : x => x\n    const enhancer = composeEnhancers(applyMiddleware(reduxSaga.sagaMiddleware, ...(middlewares || [])))\n    redux.store = createStore(redux.rootReducer, buildStore ? buildStore(refProps.current) || {} : {}, enhancer)\n    reduxSaga.rootSaga = buildRootSaga ? buildRootSaga(refDucks.current) : reduxSaga.defaultRootSaga\n    reduxSaga.sagaMiddleware.run(reduxSaga.rootSaga)\n    return redux.store\n  }\n\n  const pool = {}\n\n  Object.defineProperty(pool, 'addDuck', { value: addDuck, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'build', { value: build, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'reportError', { value: reportError, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'store', {\n    get() {\n      return redux.store\n    },\n    enumerable: true\n  })\n  Object.defineProperty(pool, 'setErrorReporter', { value: setErrorReporter, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'ducks', {\n    get() {\n      return [...(refDucks.current || [])]\n    },\n    enumerable: true\n  })\n  Object.defineProperty(pool, 'props', {\n    get() {\n      return { ...(refProps.current || {}) }\n    },\n    enumerable: true\n  })\n\n  return pool\n}\n"],"file":"Pool.js"}