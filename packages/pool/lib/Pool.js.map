{"version":3,"sources":["../src/Pool.js"],"names":["initDucksStream","Object","freeze","afterBuild","refStore","refDucks","refProps","current","forEach","duck","dispatch","type","mapActionType","payload","Pool","reportError","refErrorReporter","build","props","rootReducer","buildRootReducer","state","action","reduce","error","poolName","duckName","refStreams","stream","beforeBuild","composeEnhancers","window","__REDUX_DEVTOOLS_EXTENSION_COMPOSE__","x","middlewares","streamMiddlewares","concat","refMiddlewares","enhancer","applyMiddleware","buildStore","initProps","ducks","initDucks","initMiddlewares","streams","initStreams","console","pool","defineProperty","value","push","writable","enumerable","middleware","unshift","reporter","get"],"mappings":"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","sourcesContent":["import { createStore, applyMiddleware } from 'redux'\n\n// this pool stream will send @@INIT action to every registered duck after build\nconst initDucksStream = Object.freeze({\n  afterBuild({ refStore, refDucks, refProps } = {}) {\n    refDucks.current.forEach(duck => {\n      refStore.current.dispatch({ type: duck.mapActionType('@@INIT'), payload: refProps.current })\n    })\n  }\n})\n\n// POOL\nexport default function Pool({\n  props: initProps = {},\n  ducks: initDucks = [],\n  middlewares: initMiddlewares = [],\n  streams: initStreams = [],\n  buildStore = () => {\n    return {}\n  },\n  buildRootReducer\n} = {}) {\n  const refProps = { current: initProps || {} }\n  const refDucks = { current: initDucks || [] }\n  const refStreams = { current: [...(initStreams || []), initDucksStream] }\n  const refMiddlewares = { current: initMiddlewares || [] }\n  const refErrorReporter = { current: ('undefined' !== typeof console && console.error) || (() => {}) } // eslint-disable-line no-console\n\n  function addDuck(duck) {\n    refDucks.current.push(duck)\n  }\n\n  function addMiddleware(middleware) {\n    refMiddlewares.current.push(middleware)\n  }\n\n  function addStream(stream) {\n    refStreams.current.unshift(stream)\n  }\n\n  function setErrorReporter(reporter) {\n    refErrorReporter.current = reporter\n  }\n\n  function reportError(...args) {\n    if ('function' === typeof refErrorReporter.current) {\n      refErrorReporter.current(...args)\n    }\n  }\n\n  const refStore = { current: null }\n\n  function build(props = refProps.current) {\n    // save props\n    refProps.current = props || {}\n\n    // build root reducer\n    const rootReducer = buildRootReducer\n      ? buildRootReducer(refDucks.current, { refDucks, refErrorReporter })\n      : function defaultRootReducer(state, action) {\n          return refDucks.current.reduce((state, duck) => {\n            try {\n              return duck(state, action)\n            } catch (error) {\n              reportError(error, '@duckness/pool', 'reducer', duck.poolName, duck.duckName)\n              return state\n            }\n          }, state)\n        }\n\n    // invoke beforeBuild for each pool stream\n    refStreams.current.forEach(stream => {\n      if (stream.beforeBuild) stream.beforeBuild({ refDucks, refProps, refErrorReporter })\n    })\n\n    // compose redux middlewares\n    const composeEnhancers =\n      typeof window === 'object' && window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__\n        ? window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({})\n        : x => x\n    const middlewares = [\n      ...refStreams.current.reduce(\n        (streamMiddlewares, stream) =>\n          stream.middlewares\n            ? streamMiddlewares.concat(stream.middlewares({ refDucks, refProps, refErrorReporter }) || [])\n            : streamMiddlewares,\n        []\n      ),\n      ...refMiddlewares.current\n    ]\n    const enhancer = composeEnhancers(applyMiddleware(...middlewares))\n\n    // create store\n    refStore.current = createStore(\n      rootReducer,\n      buildStore ? buildStore(refProps.current, { refProps, refDucks, refErrorReporter }) || {} : {},\n      enhancer\n    )\n\n    // invoke afterBuild for each pool stream\n    refStreams.current.forEach(stream => {\n      if (stream.afterBuild) stream.afterBuild({ refStore, refDucks, refProps, refErrorReporter })\n    })\n\n    // return redux store\n    return refStore.current\n  }\n\n  const pool = {}\n\n  Object.defineProperty(pool, 'addDuck', { value: addDuck, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'addMiddleware', { value: addMiddleware, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'addStream', { value: addStream, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'build', { value: build, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'reportError', { value: reportError, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'setErrorReporter', { value: setErrorReporter, writable: false, enumerable: true })\n  Object.defineProperty(pool, 'store', {\n    get() {\n      return refStore.current\n    },\n    enumerable: true\n  })\n  Object.defineProperty(pool, 'ducks', {\n    get() {\n      return [...(refDucks.current || [])]\n    },\n    enumerable: true\n  })\n  Object.defineProperty(pool, 'middlewares', {\n    get() {\n      return [...(refMiddlewares.current || [])]\n    },\n    enumerable: true\n  })\n  Object.defineProperty(pool, 'streams', {\n    get() {\n      return [...(refStreams.current || [])]\n    },\n    enumerable: true\n  })\n  Object.defineProperty(pool, 'props', {\n    get() {\n      return { ...(refProps.current || {}) }\n    },\n    enumerable: true\n  })\n\n  return pool\n}\n"],"file":"Pool.js"}